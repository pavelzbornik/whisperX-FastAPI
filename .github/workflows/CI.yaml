name: CI
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true
permissions:
  contents: read
on:
  pull_request:
    branches:
      - main
      - dev
    paths:
      - "app/**"
      - "tests/**"
      - "dockerfile"
      - "docker-compose.yml"
      - "pyproject.toml"
  push:
    branches:
      - main
      - dev
    paths:
      - "app/**"
      - "tests/**"
      - "dockerfile"
      - "docker-compose.yml"
      - "pyproject.toml"
  workflow_dispatch:
  workflow_call:
jobs:
  lint:
    name: Lint and Format
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      pull-requests: write # Needed for PR failure comment
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Common setup
        uses: ./.github/actions/setup
        with:
          python-version: "3.11"
      - name: Install hadolint
        run: |
          wget -O hadolint https://github.com/hadolint/hadolint/releases/download/v2.12.0/hadolint-Linux-x86_64
          chmod +x hadolint
          sudo mv hadolint /usr/local/bin/
      - name: Run full pre-commit validation
        uses: pre-commit/action@v3.0.1
      - name: Comment on PR if lint job fails
        if: failure()
        uses: thollander/actions-comment-pull-request@v3
        with:
          message: |
            ## :x: CI Job Failed
            **Job:** `Lint and Format`
            **Error:** Code formatting or linting checks failed
            **Run ID:** [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ### :point_right: Next Steps
            - Review the [full logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for detailed error information
            - Fix the issues and push new commits to update this PR
            - The CI will automatically re-run on new commits

            ---
            <sub>This comment was automatically generated by CI failure notification</sub>
          mode: upsert
          comment-tag: ci-lint-failure
          reactions: eyes, x
  test:
    name: Test
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: lint
    env:
      HF_TOKEN: ${{ secrets.HF_TOKEN }}
      WHISPER_MODEL: tiny
      DEFAULT_LANG: en
      DEVICE: cpu
      COMPUTE_TYPE: int8
    strategy:
      matrix:
        python-version: ["3.11"]
    permissions:
      contents: read
      pull-requests: write # Needed for PR failure comment
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      - name: Common setup
        uses: ./.github/actions/setup
        with:
          python-version: ${{ matrix.python-version }}
      - name: Run tests with coverage
        run: uv run pytest --junitxml=pytest-report.xml --cov=app --cov-report=xml --cov-report=term --cov-fail-under=80
      - name: Upload test report
        uses: actions/upload-artifact@v4
        with:
          name: test-report-${{ matrix.python-version }}
          path: pytest-report.xml
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{ matrix.python-version }}
          path: coverage.xml
      - name: Comment on PR if test job fails
        if: failure()
        uses: thollander/actions-comment-pull-request@v3
        with:
          message: |
            ## :x: CI Job Failed
            **Job:** `Test`
            **Error:** Tests failed or coverage threshold not met
            **Run ID:** [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ### :point_right: Next Steps
            - Review the [full logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for detailed error information
            - Fix the issues and push new commits to update this PR
            - The CI will automatically re-run on new commits

            ---
            <sub>This comment was automatically generated by CI failure notification</sub>
          mode: upsert
          comment-tag: ci-test-failure
          reactions: eyes, x
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: write # Needed for PR failure comment
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
      - name: Comment on PR if dependency review fails
        if: failure()
        uses: thollander/actions-comment-pull-request@v3
        with:
          message: |
            ## :x: CI Job Failed
            **Job:** `Dependency Review`
            **Error:** Vulnerable dependencies detected
            **Run ID:** [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ### :point_right: Next Steps
            - Review the [full logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for detailed error information
            - Update vulnerable dependencies to secure versions
            - Push new commits to update this PR
            - The CI will automatically re-run on new commits

            ---
            <sub>This comment was automatically generated by CI failure notification</sub>
          mode: upsert
          comment-tag: ci-dependency-review-failure
          reactions: eyes, x
  build:
    name: Build and Security Scan
    runs-on: ubuntu-latest
    needs: [test]
    if: github.event_name == 'pull_request'
    timeout-minutes: 30
    permissions:
      contents: read
      pull-requests: write # Needed for PR failure comment
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: false
          docker-images: false
          swap-storage: true
      - name: Build and export to Docker
        uses: docker/build-push-action@v6
        with:
          context: .
          load: true
          push: false
          tags: whisperx-fastapi:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: whisperx-fastapi:latest
          format: "table"
          output: "trivy-results.txt"
          exit-code: "0"
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: "CRITICAL,HIGH"
      - name: Upload Trivy scan results
        uses: actions/upload-artifact@v4
        with:
          name: trivy-results
          path: trivy-results.txt
      - name: Output Trivy scan results to job summary
        if: always()
        run: |
          echo "## Trivy Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "The following vulnerabilities were found in the Docker image:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat trivy-results.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
      - name: Comment on PR if build job fails
        if: failure()
        uses: thollander/actions-comment-pull-request@v3
        with:
          message: |
            ## :x: CI Job Failed
            **Job:** `Build and Security Scan`
            **Error:** Build process or security scan failed
            **Run ID:** [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ### :point_right: Next Steps
            - Review the [full logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for detailed error information
            - Fix the issues and push new commits to update this PR
            - The CI will automatically re-run on new commits

            ---
            <sub>This comment was automatically generated by CI failure notification</sub>
          mode: upsert
          comment-tag: ci-build-failure
          reactions: eyes, x
  dependabot-auto-merge:
    name: Auto-merge Dependabot PR
    runs-on: ubuntu-latest
    needs: [build, test, dependency-review]
    if: github.event_name == 'pull_request' && github.event.pull_request.user.login == 'dependabot[bot]'
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"
      - name: Merge the PR
        run: gh pr merge "$PR_URL" --merge
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  release-please:
    name: Release Please
    runs-on: ubuntu-latest
    needs: [build, test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - uses: googleapis/release-please-action@v4
        id: release-please
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          release-type: python
      - name: Checkout release branch
        # release-please is unable to update uv.lock, so we do it ourselves

        if: ${{ steps.release-please.outputs.pr }}
        uses: actions/checkout@v5
        with:
          ref: ${{ fromJson(steps.release-please.outputs.pr).headBranchName }}
      - name: Setup uv
        if: ${{ steps.release-please.outputs.pr }}
        uses: astral-sh/setup-uv@v6
      - name: Update uv.lock
        if: ${{ steps.release-please.outputs.pr }}
        run: uv lock
      - name: Commit updated uv.lock
        if: ${{ steps.release-please.outputs.pr }}
        uses: stefanzweifel/git-auto-commit-action@v6
        with:
          commit_message: "ci: update uv.lock"
          file_pattern: uv.lock
          commit_user_name: "GitHub Action"
          commit_user_email: "action@github.com"
  auto-merge-release-please:
    name: Auto-merge Release Please PR
    runs-on: ubuntu-latest
    needs: [release-please]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
      - name: Set up GitHub CLI
        run: |
          sudo apt-get update && sudo apt-get install -y gh
      - name: Find and merge Release Please PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          prs=$(gh pr list --state open --author github-actions[bot] --json number --jq '.[].number')
          if [ -z "$prs" ]; then
            echo "No open Release Please PRs to merge."
            exit 0
          fi
          for pr in $prs; do
            echo "Merging Release Please PR #$pr"
            gh pr merge $pr --merge --admin --delete-branch || exit 1
          done
