name: CI
concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true
permissions:
  contents: read
on:
  pull_request:
    branches:
      - main
      - dev
    paths:
      - "app/**"
      - "tests/**"
      - "dockerfile"
      - "docker-compose.yml"
      - "pyproject.toml"
      - ".github/workflows/**"
      - "uv.lock"
      - ".pre-commit-config.yaml"
  push:
    branches:
      - main
      - dev
    paths:
      - "app/**"
      - "tests/**"
      - "dockerfile"
      - "docker-compose.yml"
      - "pyproject.toml"
      - ".github/workflows/**"
      - "uv.lock"
      - ".pre-commit-config.yaml"
  workflow_dispatch:
  workflow_call:
jobs:
  lint:
    name: Lint and Format
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      pull-requests: write # Needed for PR failure comment
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Common setup
        uses: ./.github/actions/setup
        with:
          python-version: "3.11"
      - name: Install hadolint
        run: |
          wget -O hadolint https://github.com/hadolint/hadolint/releases/download/v2.12.0/hadolint-Linux-x86_64
          chmod +x hadolint
          sudo mv hadolint /usr/local/bin/
      - name: Run full pre-commit validation
        uses: pre-commit/action@1b06ec171f2f6faa71ed760c4042bd969e4f8b43
      - name: Comment on PR if lint job fails
        if: failure() && github.event_name == 'pull_request'
        uses: thollander/actions-comment-pull-request@e4a76dd2b0a3c2027c3fd84147a67c22ee4c90fa
        with:
          message: |
            ## :x: CI Job Failed
            **Job:** `Lint and Format`
            **Error:** Code formatting or linting checks failed
            **Run ID:** [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ### :point_right: Next Steps
            - Review the [full logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for detailed error information
            - Fix the issues and push new commits to update this PR
            - The CI will automatically re-run on new commits

            ---
            <sub>This comment was automatically generated by CI failure notification</sub>
          mode: upsert
          comment-tag: ci-lint-failure
          reactions: eyes, x
  test:
    name: Test
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: lint
    env:
      HF_TOKEN: ${{ secrets.HF_TOKEN }}
      WHISPER_MODEL: tiny
      DEFAULT_LANG: en
      DEVICE: cpu
      COMPUTE_TYPE: int8
    strategy:
      matrix:
        python-version: ["3.11"]
    permissions:
      contents: read
      pull-requests: write # Needed for PR failure comment
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          fetch-depth: 0 # Needed for SonarQube analysis
      - name: Common setup
        uses: ./.github/actions/setup
        with:
          python-version: ${{ matrix.python-version }}
      - name: Run tests with coverage
        run: uv run pytest --junitxml=pytest-report.xml --cov=app --cov-report=xml --cov-report=term --cov-fail-under=80
      - name: Upload test report
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: test-report-${{ matrix.python-version }}
          path: pytest-report.xml
      - name: Upload coverage report
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        with:
          name: coverage-report-${{ matrix.python-version }}
          path: coverage.xml
      - name: SonarQube Cloud Scan
        uses: SonarSource/sonarqube-scan-action@a31c9398be7ace6bbfaf30c0bd5d415f843d45e9
        continue-on-error: true
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      - name: Comment on PR if test job fails
        if: failure() && github.event_name == 'pull_request'
        uses: thollander/actions-comment-pull-request@e4a76dd2b0a3c2027c3fd84147a67c22ee4c90fa
        with:
          message: |
            ## :x: CI Job Failed
            **Job:** `Test`
            **Error:** Tests failed or coverage threshold not met
            **Run ID:** [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ### :point_right: Next Steps
            - Review the [full logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for detailed error information
            - Fix the issues and push new commits to update this PR
            - The CI will automatically re-run on new commits

            ---
            <sub>This comment was automatically generated by CI failure notification</sub>
          mode: upsert
          comment-tag: ci-test-failure
          reactions: eyes, x
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    timeout-minutes: 10
    permissions:
      contents: read
      pull-requests: write # Needed for PR failure comment
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
      - name: Dependency Review
        uses: actions/dependency-review-action@98884d411b0f1c583e5ee579e7e897d4623019c2
        with:
          fail-on-severity: moderate
      - name: Comment on PR if dependency review fails
        if: failure() && github.event_name == 'pull_request'
        uses: thollander/actions-comment-pull-request@e4a76dd2b0a3c2027c3fd84147a67c22ee4c90fa
        with:
          message: |
            ## :x: CI Job Failed
            **Job:** `Dependency Review`
            **Error:** Vulnerable dependencies detected
            **Run ID:** [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ### :point_right: Next Steps
            - Review the [full logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for detailed error information
            - Update vulnerable dependencies to secure versions
            - Push new commits to update this PR
            - The CI will automatically re-run on new commits

            ---
            <sub>This comment was automatically generated by CI failure notification</sub>
          mode: upsert
          comment-tag: ci-dependency-review-failure
          reactions: eyes, x
  build:
    name: Build and Security Scan
    runs-on: ubuntu-latest
    needs: [test]
    timeout-minutes: 30
    env:
      HF_TOKEN: ${{ secrets.HF_TOKEN }}
      WHISPER_MODEL: tiny
      DEFAULT_LANG: en
      DEVICE: cpu
      COMPUTE_TYPE: int8
    permissions:
      contents: read
      pull-requests: write # Needed for PR failure comment
      security-events: write # Needed for uploading SARIF reports
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@c7c4c00f3eef127be487a50899a220e44c6bcc87
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@54081f138730dfa15788a46383842cd2f914a1be
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true # Free up ~12GB by removing large packages
          docker-images: true # Remove unused Docker images
          swap-storage: true
      - name: Build and export to Docker
        uses: docker/build-push-action@64c9b141502b80dbbd71e008a0130ad330f480f8
        with:
          context: .
          load: true
          push: false
          tags: whisperx-fastapi:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
      - name: Validate container starts successfully
        run: |
          # Run container directly without docker-compose (no GPU support required)
          CONTAINER_ID=$(docker run -d \
            -e HF_TOKEN=${{ secrets.HF_TOKEN }} \
            -e WHISPER_MODEL=tiny \
            -e DEFAULT_LANG=en \
            -e DEVICE=cpu \
            -e COMPUTE_TYPE=int8 \
            -e LOG_LEVEL=INFO \
            -e ENVIRONMENT=test \
            -e DEV=false \
            -e FILTER_WARNING=true \
            -e DB_URL=sqlite:////tmp/test.db \
            -p 8000:8000 \
            whisperx-fastapi:latest)

          echo "Started container: $CONTAINER_ID"

          # Wait for application to be ready (max 60 seconds)
          echo "Waiting for application to be ready..."
          RETRY_COUNT=0
          MAX_RETRIES=60
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HTTP_CODE=$(docker exec "$CONTAINER_ID" curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/health 2>&1 || echo "000")
            if [ "$HTTP_CODE" = "200" ]; then
              echo "✓ Application is healthy and responding (HTTP $HTTP_CODE)"
              break
            fi
            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [ $RETRY_COUNT -eq 10 ] || [ $RETRY_COUNT -eq 20 ] || [ $RETRY_COUNT -eq 30 ]; then
              echo "  (Retry $RETRY_COUNT: HTTP response $HTTP_CODE - still waiting...)"
            fi
            if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
              echo "✗ Application failed to become ready after $MAX_RETRIES seconds (Last HTTP: $HTTP_CODE)"
              echo "Container logs (last 50 lines):"
              docker logs "$CONTAINER_ID" | tail -50
              echo ""
              echo "Debugging information:"
              docker exec "$CONTAINER_ID" which curl || echo "  ✗ curl not found in PATH"
              docker stop "$CONTAINER_ID" 2>/dev/null || true
              docker rm "$CONTAINER_ID" 2>/dev/null || true
              exit 1
            fi
            sleep 1
          done

          # Verify health endpoint returns expected response
          HEALTH_RESPONSE=$(docker exec "$CONTAINER_ID" curl -s http://localhost:8000/health)
          echo "Health endpoint response: $HEALTH_RESPONSE"

          # Test other health endpoints
          echo "Testing /health/live endpoint..."
          LIVE_RESPONSE=$(docker exec "$CONTAINER_ID" curl -s http://localhost:8000/health/live)
          echo "Live endpoint response: $LIVE_RESPONSE"

          # Clean up
          docker stop "$CONTAINER_ID" 2>/dev/null || true
          docker rm "$CONTAINER_ID" 2>/dev/null || true
          echo "✓ Container validation completed successfully"
      - name: Clean up Docker build cache
        run: |
          docker builder prune -f --filter "until=1h"
          df -h
      - name: Run Trivy vulnerability scanner (SARIF format)
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8
        with:
          image-ref: whisperx-fastapi:latest
          format: "sarif"
          output: "trivy-results.sarif"
          exit-code: "0"
          ignore-unfixed: true
          vuln-type: "os,library"
          severity: "CRITICAL,HIGH"
      - name: Convert SARIF to Markdown table
        if: always()
        run: |
          wget -q https://github.com/Antvirf/go-sarif-to-markdown-table/raw/refs/heads/main/bin/sarif-to-markdown-table-linux-amd64 -O sarif-to-markdown-table-linux || \
          { echo "Failed to download SARIF conversion tool - using raw SARIF output"; cat trivy-results.sarif > trivy-results.txt; exit 0; }
          chmod +x sarif-to-markdown-table-linux
          cat trivy-results.sarif | ./sarif-to-markdown-table-linux > trivy-results.txt 2>/dev/null || cat trivy-results.sarif > trivy-results.txt
      - name: Upload Trivy scan results as artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
        if: always()
        with:
          name: trivy-results
          path: trivy-results.txt
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@b20883b0cd1f46c72ae0ba6d1090936928f9fa30
        if: always()
        with:
          sarif_file: "trivy-results.sarif"
          category: "trivy-container-scan"
      - name: Output Trivy scan results to job summary
        if: always()
        run: |
          echo "## Trivy Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "The following vulnerabilities were found in the Docker image:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          cat trivy-results.txt >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
      - name: Comment on PR if build job fails
        if: failure() && github.event_name == 'pull_request'
        uses: thollander/actions-comment-pull-request@e4a76dd2b0a3c2027c3fd84147a67c22ee4c90fa
        with:
          message: |
            ## :x: CI Job Failed
            **Job:** `Build and Security Scan`
            **Error:** Build process or security scan failed
            **Run ID:** [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ### :point_right: Next Steps
            - Review the [full logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for detailed error information
            - Fix the issues and push new commits to update this PR
            - The CI will automatically re-run on new commits

            ---
            <sub>This comment was automatically generated by CI failure notification</sub>
          mode: upsert
          comment-tag: ci-build-failure
          reactions: eyes, x
  dependabot-auto-merge:
    name: Auto-merge Dependabot PR
    runs-on: ubuntu-latest
    needs: [build, test, dependency-review]
    if: github.event_name == 'pull_request' && github.event.pull_request.user.login == 'dependabot[bot]'
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@51d7679cc74eaca941d9b749649d65ae23d98e2b
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"
      - name: Merge the PR
        run: gh pr merge "$PR_URL" --merge --admin
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  release-please:
    name: Release Please
    runs-on: ubuntu-latest
    needs: [build, test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - uses: googleapis/release-please-action@16a9c90856f42705d54a6fda1823352bdc62cf38
        id: release-please
        with:
          token: ${{ secrets.PAT_TOKEN }}
          release-type: python
      - name: Checkout release branch
        # release-please is unable to update uv.lock, so we do it ourselves

        if: ${{ steps.release-please.outputs.pr }}
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          ref: ${{ fromJson(steps.release-please.outputs.pr).headBranchName }}
      - name: Setup uv
        if: ${{ steps.release-please.outputs.pr }}
        uses: astral-sh/setup-uv@61cb8a9741eeb8a550a1b8544337180c0fc8476b
      - name: Update uv.lock
        if: ${{ steps.release-please.outputs.pr }}
        run: uv lock
      - name: Commit updated uv.lock
        if: ${{ steps.release-please.outputs.pr }}
        uses: stefanzweifel/git-auto-commit-action@6739571eaee7f2e84e98784215d23acd69740d13
        with:
          commit_message: "ci: update uv.lock"
          file_pattern: uv.lock
          commit_user_name: "GitHub Action"
          commit_user_email: "action@github.com"
  auto-merge-release-please:
    name: Auto-merge Release Please PR
    runs-on: ubuntu-latest
    needs: [release-please]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
      - name: Set up GitHub CLI
        run: |
          sudo apt-get update && sudo apt-get install -y gh
      - name: Find and merge Release Please PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          prs=$(gh pr list --state open --author github-actions[bot] --json number --jq '.[].number')
          if [ -z "$prs" ]; then
            echo "No open Release Please PRs to merge."
            exit 0
          fi
          for pr in $prs; do
            echo "Merging Release Please PR #$pr"
            gh pr merge $pr --merge --admin --delete-branch || exit 1
          done
